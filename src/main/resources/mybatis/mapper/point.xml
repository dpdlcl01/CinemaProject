<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="point">

    <select id="selectPoint" parameterType="String" resultType="int">
        SELECT p.pointValue
        FROM point p
        JOIN payment pay ON p.paymentIdx = pay.paymentIdx
        WHERE pay.reservationIdx = #{reservationIdx}
    </select>


    <update id="deletePoint" parameterType="String">
        UPDATE point p
        JOIN payment pay ON p.paymentIdx = pay.paymentIdx
        SET p.pointStatus = 1
        WHERE pay.reservationIdx = #{reservationIdx}
    </update>


    <insert id="insertPoint" parameterType="map">
        insert into point(userIdx, paymentIdx, pointType, pointSource, pointValue, pointDate, pointStatus)
        values(#{userIdx}, #{paymentIdx}, 0, 'PAYMENT', #{pointSource}, now(), '0');
    </insert>


    <update id="updatePoint" parameterType="map">
        UPDATE user
        SET userPoint = userPoint - #{point} + #{addpoint}
        WHERE userIdx = #{userIdx}
    </update>


    <!--  사용자 포인트 조회  -->
    <select id="userPoint" parameterType="map" resultType="mybatis.vo.PointVO">
        SELECT pointIdx, userIdx, pointType,
        pointSource, pointValue, pointDate, pointStatus
        FROM point
        WHERE userIdx = #{userIdx}
        ORDER BY pointDate DESC
        LIMIT #{begin}, #{end}
    </select>

    <!-- 사용 가능 포인트 계산 -->
    <select id="availablePoints" parameterType="string" resultType="int">
        SELECT SUM(
            CASE
                WHEN pointType = 0 THEN pointValue    <!-- 적립 -->
                WHEN pointType = 1 THEN -pointValue  <!-- 사용 -->
                WHEN pointType = 2 THEN 0           <!-- 만료 -->
            END
        ) AS availablePoints
        FROM point
        WHERE userIdx = #{userIdx} AND pointStatus = 0; <!-- 정상 상태만 포함 -->
    </select>

    <!-- VIP 선정 포인트 계산 -->
    <select id="vipPoints" parameterType="string" resultType="int">
        SELECT SUM(pointValue)
        FROM point
        WHERE userIdx = #{userIdx} AND pointType = 0 AND pointStatus = 0; <!-- 적립된 포인트만 계산 -->
    </select>

    <!--  기간별 포인트 이용 내역 조회  -->
    <select id="getPointList" parameterType="map" resultType="mybatis.vo.PointVO">
        SELECT pointIdx, userIdx, pointDate, pointType, pointSource, pointValue, pointStatus
        FROM point
        WHERE userIdx = #{userIdx}
        AND pointDate BETWEEN CONCAT(#{startDate}, ' 00:00:00') AND CONCAT(#{endDate}, ' 23:59:59')
        ORDER BY pointDate DESC
    </select>

</mapper>